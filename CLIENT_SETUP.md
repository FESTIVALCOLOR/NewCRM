# Настройка клиента Interior Studio CRM для многопользовательской работы

## Что сделано автоматически

После развертывания сервера на Timeweb Cloud (IP: 147.45.154.193), клиентское приложение PyQt5 было автоматически настроено для работы в многопользовательском режиме.

---

## Изменения в коде

### 1. config.py - добавлены настройки многопользовательского режима

```python
# ========== МНОГОПОЛЬЗОВАТЕЛЬСКИЙ РЕЖИМ ==========
# Включить многопользовательский режим (работа через API сервер)
MULTI_USER_MODE = True

# URL API сервера (замените на ваш сервер)
API_BASE_URL = "https://147.45.154.193"

# Интервал синхронизации с сервером (секунды)
SYNC_INTERVAL = 5

# Локальный кэш данных
CACHE_ENABLED = True
CACHE_PATH = os.path.join(BASE_DIR, 'cache')
# ===================================================
```

### 2. ui/login_window.py - добавлена поддержка API аутентификации

**Импорты:**
```python
from config import MULTI_USER_MODE, API_BASE_URL

# ========== API CLIENT ==========
if MULTI_USER_MODE:
    from utils.api_client import APIClient
# ================================
```

**Инициализация API клиента:**
```python
def __init__(self):
    super().__init__()
    self.db = DatabaseManager()
    self.main_window = None
    self.api_client = None

    # Инициализация API клиента если включен многопользовательский режим
    if MULTI_USER_MODE:
        try:
            self.api_client = APIClient(API_BASE_URL)
            app_logger.info(f"API клиент инициализирован: {API_BASE_URL}")
        except Exception as e:
            app_logger.error(f"Ошибка инициализации API клиента: {e}")

    self.init_ui()
```

**Метод login() с поддержкой двух режимов:**
- **API режим** (если MULTI_USER_MODE = True):
  - Аутентификация через REST API сервер
  - Получение JWT токена
  - Информативные сообщения об ошибках (неверный пароль / нет связи с сервером)

- **Локальный режим** (если MULTI_USER_MODE = False):
  - Аутентификация через локальную SQLite базу
  - Работает как раньше (без изменений)

### 3. ui/main_window.py - добавлена поддержка API клиента

```python
class MainWindow(QMainWindow):
    def __init__(self, employee_data, api_client=None):
        super().__init__()
        self.employee = employee_data
        self.api_client = api_client  # API клиент для многопользовательского режима
        self.db = DatabaseManager()
```

Теперь MainWindow принимает опциональный параметр `api_client`, который используется для синхронизации данных с сервером.

---

## Как это работает

### Процесс входа в систему:

1. **Пользователь запускает приложение**
   - LoginWindow проверяет флаг `MULTI_USER_MODE` из config.py

2. **MULTI_USER_MODE = True** (многопользовательский режим):
   - LoginWindow инициализирует APIClient с адресом `API_BASE_URL`
   - При вводе логина/пароля отправляется POST запрос на `/api/auth/login`
   - Сервер проверяет учетные данные в PostgreSQL
   - При успехе возвращается JWT токен и данные пользователя
   - MainWindow открывается с переданным `api_client`
   - Все операции с данными идут через API

3. **MULTI_USER_MODE = False** (локальный режим):
   - LoginWindow работает с локальной SQLite базой
   - MainWindow работает без api_client
   - Все операции идут через локальную БД

### Обработка ошибок:

**API режим показывает понятные сообщения:**
- **401 Unauthorized** → "Неверный логин или пароль!"
- **ConnectionError/Timeout** → "Ошибка подключения к серверу. Проверьте интернет соединение и доступность сервера: https://147.45.154.193"
- **Другие ошибки** → Текст ошибки от сервера

---

## Переключение между режимами

### Для работы с API сервером (многопользовательский режим):

```python
# config.py
MULTI_USER_MODE = True
API_BASE_URL = "https://147.45.154.193"  # Ваш сервер
```

### Для работы локально (однопользовательский режим):

```python
# config.py
MULTI_USER_MODE = False
```

При переключении режимов не требуется изменений в коде - все работает автоматически!

---

## Учетные данные для тестирования

После развертывания сервера был создан администратор:

- **Логин:** admin
- **Пароль:** admin123
- **Роль:** Руководитель студии

**ВАЖНО:** Сразу после первого входа смените пароль!

---

## Проверка подключения к серверу

### Способ 1: Через браузер

Откройте в браузере:
```
https://147.45.154.193
```

Должны увидеть:
```json
{
  "app": "Interior Studio CRM API",
  "version": "1.0.0",
  "status": "running"
}
```

### Способ 2: Через Python

```python
from utils.api_client import APIClient

# Проверка подключения
api = APIClient("https://147.45.154.193")

# Проверка входа
result = api.login("admin", "admin123")
print(result)
```

---

## Логирование

Все события входа логируются:

**Логи сохраняются в:** `logs/app.log`

**Примеры записей:**

```
[INFO] API клиент инициализирован: https://147.45.154.193
[INFO] API аутентификация: логин='admin'
[INFO] Успешный API вход: Администратор (роль: Руководитель студии)
```

При ошибках:
```
[ERROR] Ошибка API входа: Не удалось войти: Неверный логин или пароль
[ERROR] Ошибка инициализации API клиента: Connection refused
```

---

## Устранение проблем

### Ошибка: "Ошибка подключения к серверу"

**Причины:**
1. Нет интернета на клиентском компьютере
2. Сервер недоступен (остановлен, перезагружается)
3. Firewall блокирует соединение
4. Неверный URL в config.py

**Решение:**
```bash
# Проверить доступность сервера
ping 147.45.154.193

# Проверить HTTPS доступ
curl https://147.45.154.193
```

### Ошибка: "Неверный логин или пароль"

**Причины:**
1. Опечатка в логине/пароле
2. Пользователь не создан на сервере
3. Пользователь деактивирован (status != 'активный')

**Решение:**
```bash
# Подключиться к серверу по SSH
ssh root@147.45.154.193

# Проверить пользователей
docker-compose -f /opt/interior_studio/docker-compose.yml exec postgres psql -U crm_user -d interior_studio_crm -c "SELECT id, login, full_name, status FROM employees;"
```

### Ошибка: "ModuleNotFoundError: No module named 'utils.api_client'"

**Причина:** Файл `utils/api_client.py` не был создан на клиенте

**Решение:** Скопировать файл с сервера или из репозитория

### Переключение обратно на локальный режим

Если сервер недоступен, можно временно переключиться:

```python
# config.py
MULTI_USER_MODE = False  # Временно работаем локально
```

Перезапустить приложение - будет использоваться локальная SQLite база.

---

## Развертывание на других компьютерах

### Шаг 1: Установить приложение

Скопировать папку `interior_studio` или установить через installer (если есть).

### Шаг 2: Настроить config.py

```python
# config.py
MULTI_USER_MODE = True
API_BASE_URL = "https://147.45.154.193"  # Адрес вашего сервера
SYNC_INTERVAL = 5
```

### Шаг 3: Проверить подключение

Запустить приложение и войти с учетными данными:
- Логин: admin
- Пароль: admin123

### Шаг 4: Создать пользователей

Через интерфейс (вкладка "Сотрудники") или через SQL:

```sql
-- Подключиться к PostgreSQL
docker-compose exec postgres psql -U crm_user -d interior_studio_crm

-- Создать пользователя
INSERT INTO employees (
    full_name, phone, email, login, password_hash,
    position, department, role, status,
    created_at, updated_at
) VALUES (
    'Иван Иванов',
    '+7 999 123-45-67',
    'ivanov@studio.ru',
    'ivanov',
    '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5oDgbHQJO9EGu',  -- admin123
    'Менеджер',
    'Отдел продаж',
    'Менеджер',
    'активный',
    NOW(),
    NOW()
);
```

---

## Следующие шаги

1. **Добавить синхронизацию данных** (SyncManager) - для автоматического обновления данных каждые 5 секунд
2. **Обновить вкладки** (ClientsTab, ContractsTab, CRMTab и т.д.) для работы через API вместо локальной БД
3. **Добавить индикатор онлайн статуса** - показывать кто онлайн
4. **Добавить уведомления** - о действиях других пользователей
5. **Настроить токен Яндекс.Диска** на сервере для загрузки файлов

---

## Контакты

**Сервер:** https://147.45.154.193
**Репозиторий:** https://github.com/FESTIVALCOLOR/NewCRM
**Документация сервера:** TIMEWEB_DEPLOY.md
**Документация API:** MULTI_USER_SETUP.md

**Логи сервера:**
```bash
ssh root@147.45.154.193
cd /opt/interior_studio
docker-compose logs -f api
```

---

**Статус:** Готово к тестированию
**Дата:** 23.12.2025
