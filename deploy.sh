#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Git –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ 147.45.154.193

echo "======================================"
echo "–†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ù–ê –°–ï–†–í–ï–† 147.45.154.193"
echo "======================================"

SERVER="147.45.154.193"
USER="root"
PATH_ON_SERVER="/root/interior_studio"

echo ""
echo "üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É..."

ssh $USER@$SERVER << 'ENDSSH'
    echo "‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É"

    # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
    cd /root/interior_studio || exit 1
    echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
    echo ""
    echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ Git..."
    git fetch origin

    # –ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    echo ""
    echo "üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:"
    git log HEAD..origin/main --oneline

    # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    echo ""
    echo "üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
    git pull origin main

    if [ $? -ne 0 ]; then
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        exit 1
    fi
    echo "‚úì –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    echo ""
    echo "üìö –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python..."
    python3 -m pip install -r requirements.txt --quiet
    echo "‚úì –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"

    # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
    echo ""
    echo "üóÑÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    python3 migrate_to_server.py
    echo "‚úì –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã"

    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
    echo ""
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."

    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
    pkill -f "uvicorn server.main:app" || true
    sleep 2
    echo "‚úì –°—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

    # –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
    nohup python3 -m uvicorn server.main:app --host 0.0.0.0 --port 8000 > /var/log/interior_studio.log 2>&1 &
    sleep 3

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞
    if pgrep -f "uvicorn server.main:app" > /dev/null; then
        PID=$(pgrep -f "uvicorn server.main:app")
        echo "‚úì –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $PID)"
    else
        echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø—É—Å–∫"
        echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -f /var/log/interior_studio.log"
    fi

    echo ""
    echo "======================================"
    echo "‚úÖ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û"
    echo "======================================"
    echo "üåê API: http://147.45.154.193:8000"
    echo "üìñ Docs: http://147.45.154.193:8000/docs"
    echo "======================================"
ENDSSH

echo ""
echo "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "ssh $USER@$SERVER 'tail -f /var/log/interior_studio.log'"
