# Пошаговое развертывание CRM на сервере
# Выполнять команды по очереди на сервере 147.45.154.193

## ===== ШАГ 1: Подключение к серверу =====
ssh root@147.45.154.193
cd /opt/interior_studio

## ===== ШАГ 2: Резервные копии =====
cp server/database.py server/database.py.backup
cp server/schemas.py server/schemas.py.backup
cp server/main.py server/main.py.backup

## ===== ШАГ 3: Создание таблиц в PostgreSQL =====
# Войти в PostgreSQL
docker exec -it interior_studio-db-1 psql -U interior_admin -d interior_studio_db

# Скопировать и выполнить содержимое файла server_crm_migration.sql
# (Содержимое находится в d:\New CRM\interior_studio\server_crm_migration.sql)

# Проверить создание таблиц:
\d crm_cards
\d stage_executors

# Выйти из PostgreSQL
\q

## ===== ШАГ 4: Обновление server/database.py =====
# Открыть файл для редактирования
nano server/database.py

# Прокрутить в самый конец файла (после всех существующих моделей)
# Скопировать содержимое из файла server_crm_models.py
# Добавить в конец файла

# Также нужно добавить в модель Contract:
# Найти: class Contract(Base):
# Добавить в конец модели (перед другими моделями):
#     crm_card = relationship("CRMCard", back_populates="contract", uselist=False)

# Сохранить: Ctrl+O, Enter, Ctrl+X

## ===== ШАГ 5: Обновление server/schemas.py =====
# Открыть файл для редактирования
nano server/schemas.py

# Прокрутить в самый конец файла
# Скопировать содержимое из файла server_crm_schemas.py
# Добавить в конец файла

# Сохранить: Ctrl+O, Enter, Ctrl+X

## ===== ШАГ 6: Обновление server/main.py =====
# Открыть файл для редактирования
nano server/main.py

# 6.1: Добавить импорты в начало файла (после существующих импортов):
from database import CRMCard, StageExecutor
from schemas import (
    CRMCardUpdate, ColumnMoveRequest,
    StageExecutorCreate, StageExecutorUpdate
)
from sqlalchemy import or_

# 6.2: Прокрутить в самый конец файла (после всех роутов)
# Скопировать содержимое из файла server_crm_routes.py
# Добавить в конец файла

# Сохранить: Ctrl+O, Enter, Ctrl+X

## ===== ШАГ 7: Пересборка Docker =====
# Пересобрать образ API
docker-compose build api

# Перезапустить контейнеры
docker-compose down
docker-compose up -d

# Проверить логи
docker-compose logs -f api
# (Ctrl+C для выхода)

## ===== ШАГ 8: Проверка =====
# Проверить статус контейнеров
docker-compose ps

# Проверить доступность API
curl -k https://localhost

# Войти и получить токен
TOKEN=$(curl -k -X POST https://localhost/api/auth/login \
  -d "username=admin&password=admin123" \
  | jq -r '.access_token')

# Попробовать получить CRM карточки
curl -k -H "Authorization: Bearer $TOKEN" \
  "https://localhost/api/crm/cards?project_type=Индивидуальный"

# Если вернулся пустой массив [] - это нормально (нет данных)
# Если вернулась ошибка 500 - смотреть логи: docker-compose logs api

## ===== ШАГ 9: В случае ошибок =====
# Восстановить из резервной копии
cp server/database.py.backup server/database.py
cp server/schemas.py.backup server/schemas.py
cp server/main.py.backup server/main.py

# Перезапустить
docker-compose down
docker-compose build api
docker-compose up -d
