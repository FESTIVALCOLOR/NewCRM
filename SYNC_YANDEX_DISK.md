# Автоматическая синхронизация файлов с Яндекс.Диска

## Что это?

Теперь программа умеет **двустороннюю синхронизацию** с Яндекс.Диском:

1. **Удаление файлов** - если файл удален с Яндекс.Диска напрямую, программа автоматически удалит его запись из базы данных
2. **Добавление файлов** - если вы добавите файл напрямую на Яндекс.Диск, программа автоматически добавит его в базу данных

## Как это работает?

При открытии карточки договора программа автоматически:

1. Проверяет наличие всех файлов из БД на Яндекс.Диске
2. Сканирует папки на Яндекс.Диске в поисках новых файлов
3. Обновляет базу данных и интерфейс

## Структура папок на Яндекс.Диске

Для каждого договора создается папка по схеме:
```
disk:/АРХИВ ПРОЕКТОВ/[Агент]/[Тип проекта]/[Город]/[Название проекта]/
```

Внутри папки проекта есть подпапки:

### 1. Папка "Документы"
Программа найдет **любой файл** со словом "договор" или "contract" в названии:

✅ **Примеры файлов, которые будут найдены:**
- `Договор.pdf`
- `Договор Иванов.pdf`
- `Индивидуальный договор СПБ.docx`
- `договор_на_оказание_услуг_2024.pdf`
- `Contract_123.pdf`

❌ **НЕ будут найдены:**
- `Соглашение.pdf` (нет слова "договор")
- `Договор.txt` (неправильное расширение)

**Поддерживаемые расширения**: `.pdf`, `.docx`, `.doc`

**Важно**: Для индивидуальных проектов файл добавится как обычный договор, для шаблонных - как шаблонный договор.

### 2. Папка "Анкета"
Программа найдет **любой файл** со словом "тз", "анкета" или "техническое задание" в названии:

✅ **Примеры файлов, которые будут найдены:**
- `ТЗ.pdf`
- `ТЗ для Иванова.docx`
- `Анкета клиента.pdf`
- `тз_проект_123.pdf`
- `Техническое задание на дизайн.docx`

❌ **НЕ будут найдены:**
- `Опросник.pdf` (нет ключевых слов)
- `ТЗ.txt` (неправильное расширение)

**Поддерживаемые расширения**: `.pdf`, `.docx`, `.doc`

### 3. Папка "Замер"
Программа найдет **любой файл** со словом "замер" или "measurement" в названии:

✅ **Примеры файлов, которые будут найдены:**
- `Замер.pdf`
- `Замер квартиры.jpg`
- `замер_кухни_2024.png`
- `Результаты замера.pdf`

❌ **НЕ будут найдены:**
- `Измерения.pdf` (нет слова "замер")
- `Замер.txt` (неправильное расширение)

**Поддерживаемые расширения**: `.pdf`, `.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp`

## Как протестировать?

### Тест 1: Добавление файла на Яндекс.Диск

1. Откройте Яндекс.Диск в браузере
2. Найдите папку нужного договора
3. Создайте подпапку (если её нет): `Документы`, `Анкета` или `Замер`
4. Загрузите файл с соответствующим именем, например:
   - `Договор Иванов.pdf` в папку "Документы"
   - `ТЗ для клиента.docx` в папку "Анкета"
   - `Замер кухни.jpg` в папку "Замер"
5. Откройте карточку этого договора в программе
6. **Результат**: Файл должен автоматически появиться в карточке договора с кликабельной ссылкой

**Важно**: Название файла должно содержать ключевое слово ("договор", "тз", "анкета", "замер") и иметь правильное расширение!

### Тест 2: Удаление файла с Яндекс.Диска

1. Откройте Яндекс.Диск в браузере
2. Удалите любой файл, который есть в программе (ТЗ, Договор, Замер)
3. Откройте карточку этого договора в программе
4. **Результат**: Файл должен автоматически исчезнуть из интерфейса программы

## Отладочная информация

В консоли программы будут выводиться сообщения:

### При синхронизации новых файлов:
```
[DEBUG SYNC] Начинаем синхронизацию файлов для договора 123
[DEBUG SYNC] Папка на Яндекс.Диске: disk:/АРХИВ ПРОЕКТОВ/...
[DEBUG SYNC] Проверяем папку: disk:/АРХИВ ПРОЕКТОВ/.../Документы
[DEBUG SYNC] Найдено файлов в папке: 5
[DEBUG SYNC] Проверяем файл: Смета.xlsx
[DEBUG SYNC] Файл 'Смета.xlsx' имеет неподходящее расширение
[DEBUG SYNC] Проверяем файл: Договор Иванов СПБ.pdf
[INFO SYNC] Найден файл 'Договор Иванов СПБ.pdf' на Яндекс.Диске! (ключевое слово: 'договор')
[OK SYNC] Файл 'Договор Иванов СПБ.pdf' добавлен в очередь для синхронизации
[INFO SYNC] Обновляем БД: {...}
[OK SYNC] Синхронизация завершена! Добавлено полей: 3
```

### При проверке существования файлов:
```
[DEBUG] Проверяем файл договора: disk:/АРХИВ ПРОЕКТОВ/.../Документы/Договор.pdf
[DEBUG] Файл договора найден на Яндекс.Диске
```

или если файл удален:
```
[DEBUG] Проверяем файл ТЗ: disk:/АРХИВ ПРОЕКТОВ/.../Анкета/ТЗ.pdf
[INFO] Файл ТЗ не найден на Яндекс.Диске, удаляем из БД
```

## Важные замечания

1. **Ключевые слова в названии** - программа ищет файлы, содержащие определенные слова в названии ("договор", "тз", "анкета", "замер")
2. **Регистр не важен** - можно писать "Договор.pdf", "договор.pdf" или "ДОГОВОР.pdf"
3. **Расширение файла важно** - программа проверяет расширение файла (`.pdf`, `.docx`, `.jpg` и т.д.)
4. **Можно добавлять дополнительную информацию в название** - например, "Договор Иванов СПБ 2024.pdf" будет найден
5. **Синхронизация происходит только при открытии карточки** - если карточка уже открыта, нужно закрыть и открыть заново
6. **Файлы не перезаписываются** - если файл уже есть в БД, он не будет заменен при повторной синхронизации
7. **Работает в фоновом режиме** - синхронизация не блокирует интерфейс программы
8. **Берется первый найденный файл** - если в папке несколько файлов подходят под критерии, программа возьмет первый найденный

## Технические детали

### Функции в contracts_tab.py:

1. **`verify_files_on_yandex_disk()`** (строка 1444)
   - Проверяет существование файлов из БД на Яндекс.Диске
   - Удаляет записи о несуществующих файлах

2. **`sync_files_from_yandex_disk()`** (строка 1536)
   - Сканирует папки на Яндекс.Диске
   - Ищет файлы по ключевым словам и расширениям
   - Добавляет новые файлы в БД
   - Работает только для файлов, которых еще нет в БД
   - **Поиск по ключевым словам:**
     - Договор: `['договор', 'contract']` + расширения `.pdf`, `.docx`, `.doc`
     - ТЗ: `['тз', 'анкета', 'техническое задание']` + расширения `.pdf`, `.docx`, `.doc`
     - Замер: `['замер', 'measurement']` + расширения `.pdf`, `.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp`

3. **`refresh_file_labels()`** (строка 1703)
   - Обновляет отображение файлов в интерфейсе
   - Вызывается после синхронизации

### Вызовы (строки 1439-1442):
```python
# Проверяем файлы на Яндекс.Диске в фоновом режиме
self.verify_files_on_yandex_disk()

# Синхронизируем файлы с Яндекс.Диска (добавляем новые файлы в БД)
self.sync_files_from_yandex_disk()
```

Обе функции работают в фоновом потоке и не блокируют интерфейс.
