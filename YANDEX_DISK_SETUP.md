# Настройка интеграции с Яндекс.Диском

## Описание функциональности

Система автоматически создает структуру папок на Яндекс.Диске для каждого договора по следующей схеме:

```
АРХИВ ПРОЕКТОВ/
├── ФЕСТИВАЛЬ/
│   ├── Индивидуальные/
│   │   ├── СПБ/
│   │   │   └── СПб-Адрес-Площадь м2/
│   │   ├── МСК/
│   │   └── ВН/
│   ├── Шаблонные/
│   │   ├── СПБ/
│   │   ├── МСК/
│   │   └── ВН/
│   └── Авторские надзоры/
│       ├── СПБ/
│       ├── МСК/
│       └── ВН/
└── ПЕТРОВИЧ/
    ├── Индивидуальные/
    ├── Шаблонные/
    └── Авторские надзоры/
```

## Функции интеграции

1. **Создание папки** - при создании нового договора автоматически создается соответствующая папка
2. **Перемещение папки** - при изменении типа агента, типа проекта, города, адреса или статуса папка автоматически перемещается
3. **Удаление папки** - при удалении договора папка удаляется с Яндекс.Диска

## Как получить токен Яндекс.Диска

### Шаг 1: Создание приложения

1. Перейдите на https://oauth.yandex.ru/
2. Нажмите "Зарегистрировать новое приложение"
3. Заполните форму:
   - Название: "Interior Studio CRM" (или любое другое)
   - Платформа: Выберите "Веб-сервисы"
   - Redirect URI: можно оставить пустым или указать http://localhost
4. В разделе "Доступы" выберите:
   - **Яндекс.Диск REST API** → **Доступ к папке приложения на Диске** (cloud_api:disk.app_folder)

   ИЛИ (если нужен полный доступ):

   - **Яндекс.Диск REST API** → **Запись в любом месте на Диске** (cloud_api:disk.write)
5. Нажмите "Создать приложение"
6. Скопируйте **ID приложения** (ClientID)

### Шаг 2: Получение токена

1. Откройте в браузере URL:
   ```
   https://oauth.yandex.ru/authorize?response_type=token&client_id=ВАШ_CLIENT_ID
   ```
   Замените `ВАШ_CLIENT_ID` на ID приложения из Шага 1

2. Разрешите доступ приложению
3. Вы будете перенаправлены на страницу с токеном в адресной строке:
   ```
   http://localhost/#access_token=ВАШ_ТОКЕН&...
   ```
4. Скопируйте значение после `access_token=` и до следующего `&`

### Шаг 3: Установка токена

**Вариант 1: Переменная окружения (рекомендуется)**

Windows:
```cmd
setx YANDEX_DISK_TOKEN "ваш_токен_здесь"
```

Linux/Mac:
```bash
export YANDEX_DISK_TOKEN="ваш_токен_здесь"
```

**Вариант 2: Прямо в config.py**

Откройте файл `config.py` и измените строку:
```python
YANDEX_DISK_TOKEN = os.getenv('YANDEX_DISK_TOKEN', None)
```

на:
```python
YANDEX_DISK_TOKEN = "ваш_токен_здесь"
```

### Шаг 4: Создание корневой папки

Перед первым использованием создайте папку "АРХИВ ПРОЕКТОВ" в корне вашего Яндекс.Диска.

## Проверка работы

1. Создайте новый договор с заполненными полями:
   - Тип агента
   - Тип проекта
   - Город
   - Адрес
   - Площадь

2. Проверьте консоль приложения - должно появиться сообщение:
   ```
   [OK] Папка создана на Яндекс.Диске: disk:/АРХИВ ПРОЕКТОВ/...
   ```

3. Откройте Яндекс.Диск и убедитесь, что папка создана в нужном месте

## Устранение проблем

**Ошибка: "[ERROR] Токен не установлен"**
- Проверьте, что токен правильно установлен в config.py или в переменной окружения
- Перезапустите приложение после установки токена

**Ошибка: "401 Unauthorized"**
- Токен истек или недействителен
- Получите новый токен по инструкции выше

**Ошибка: "403 Forbidden"**
- У токена нет необходимых прав
- Убедитесь, что при создании приложения выбраны правильные доступы

**Папка не создается**
- Убедитесь, что все обязательные поля договора заполнены (тип агента, адрес, площадь)
- Проверьте, что папка "АРХИВ ПРОЕКТОВ" существует на Яндекс.Диске
- Проверьте консоль на наличие сообщений об ошибках

## Безопасность

⚠️ **ВАЖНО**: Не передавайте токен третьим лицам!
- Храните токен в безопасности
- Не коммитьте токен в Git
- Используйте переменные окружения для хранения токена
